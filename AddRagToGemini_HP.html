<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini RAG Chatbot</title>
    <style>
        /* ... å‰å›ã®å›ç­”ã¨åŒã˜ CSS ... */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f9; }
        .chat-container { max-width: 600px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .message-box { height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background-color: #e9ecef; border-radius: 4px; }
        .user-message { text-align: right; color: #007bff; margin: 5px 0; }
        .gemini-message { text-align: left; color: #28a745; margin: 5px 0; }
        input[type="text"] { width: calc(100% - 80px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { width: 70px; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background-color: #a0c9f5; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="chat-container">
    <h2>ğŸ¤– Gemini RAG Chatbot (FastAPI)</h2>
    <div id="chat-box" class="message-box">
        <div class="gemini-message">Gemini: RAGã‚¨ãƒ³ã‚¸ãƒ³ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã«é–¢ã™ã‚‹è³ªå•ã‚’ã©ã†ãã€‚(ID: test-user-001)</div>
    </div>
    <input type="text" id="user-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." onkeydown="if(event.key === 'Enter') sendMessage()">
    <button onclick="sendMessage()" id="send-button">é€ä¿¡</button>
</div>

<script>
    const API_ENDPOINT = 'http://127.0.0.1:8000/chat';
    const USER_ID = 'test-user-001'; 

    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    let currentGeminiMessageElement = null;

    function appendMessage(sender, text, isStreaming = false) {
        if (sender === 'Gemini' && isStreaming) {
            currentGeminiMessageElement = document.createElement('div');
            currentGeminiMessageElement.className = 'gemini-message';
            currentGeminiMessageElement.textContent = 'Gemini: ' + text;
            chatBox.appendChild(currentGeminiMessageElement);
        } else if (sender === 'Gemini' && currentGeminiMessageElement) {
            currentGeminiMessageElement.textContent += text;
        } else {
            const msgElement = document.createElement('div');
            msgElement.className = sender === 'User' ? 'user-message' : 'gemini-message';
            msgElement.textContent = `${sender}: ${text}`;
            chatBox.appendChild(msgElement);
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        appendMessage('User', message);
        userInput.value = '';
        sendButton.disabled = true;

        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: USER_ID, message: message }),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let firstChunk = true;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                
                if (firstChunk) {
                    appendMessage('Gemini', chunk, true); 
                    firstChunk = false;
                } else {
                    appendMessage('Gemini', chunk, false);
                }
            }
            
            currentGeminiMessageElement = null;

        } catch (error) {
            console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            appendMessage('Gemini (Error)', 'å¿œç­”ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        } finally {
            sendButton.disabled = false;
            userInput.focus();
        }
    }
</script>

</body>
</html>